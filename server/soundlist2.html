<!doctype html>
<html>
  <head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <title>Sound List View - Home Sounds</title>
    <style>
    body { font: 18px Helvetica, Arial; }

	* {
	  box-sizing: border-box;
	}

	#eventTable, #historyTable {
	  border-collapse: collapse;
	  width: 100%;
	  border: 1px solid #ddd;
	}

	#eventTable th, #historyTable th, #eventTable td, #historyTable td {
	  text-align: left;
	  padding: 12px;
	}

	#eventTable tr, #historyTable tr {
	  border-bottom: 1px solid #ddd;
	}

	#eventTable tr.header, #eventTable tr:hover, #historyTable tr.header, #historyTable tr:hover {
	  background-color: #f1f1f1;
	}  
    </style>
  </head>
  <body>
    <table id="eventTable">
	  <tr class="header">
		<th style="width:30%;">Time</th>
		<th style="width:20%;">Level</th>
		<th style="width:30%;">Location</th>
		<th style="width:%;">Length</th>
	  </tr>
	  <!--
	  <tr> <td>10:07:45</td> <td>Microwave beep</td> <td>Kitchen</td> <td>Kitchen</td> </tr>
      <tr> <td>10:08:01</td> <td>Bird chirp</td> <td>Outside</td> <td>Kitchen</td></tr>
	  <tr> <td>10:08:38</td> <td>Clap</td> <td>Dining</td> <td>Kitchen</td></tr>
      <tr> <td>16:05:41</td> <td>Liquid pour</td> <td>Dining</td> <td>Kitchen</td> </tr> 
      -->	
	</table>
	<p></p>
	<table id="historyTable">
	  <tr class="header">
		<th style="width:30%;">Location</th>
		<th style="width:20%;">Low</th>
		<th style="width:30%;">Med</th>
		<th style="width:%;">High</th>
	  </tr>	
	  <tr id="first-room"> <td>dj-home</td> <td>0</td> <td>0</td> <td>0</td> </tr>
      <tr id="second-room"> <td>dj-office</td> <td>0</td> <td>0</td> <td>0</td></tr>
	</table>
  
    <script>
	
	var FIRST_ROOM = "dj-home", SECOND_ROOM = "dj-office", THIRD_ROOM = "jon-office";	
	var lengthOfGapInSec = 1;																	//Expected pause for an event to be marked set from server during handshake
	/**** Data from Socket ****/
	
      var socket = io.connect({'reconnection': true, 'timeout': 5*86400*1000});					//URL is windows.location (url address of the webpage), timeout: 5 days
      
      // Send handshake
	  socket.on('connect', function () {
		//socket.receiveBuffer = [];			//Clear buffer
		console.log("Soundlist connected to server!");
		socket.emit('handshake', "http-soundlist");
	  });
	  
	  socket.on('handshake-server-list', function (data) {
		data = JSON.parse(data);
		lengthOfGapInSec = parseFloat(data.lengthOfGapInSec);
		
		for(i = data.listArraylen; i < 20; i++)
			$('#eventTable tr:last').after('<tr><td>' + data.listArray[i][0] +  '</td> <td>' + data.listArray[i][1] + '</td> <td>' + data.listArray[i][2] + '</td> <td>'  + data.listArray[i][3] + '</td> </tr>');
		window.scrollTo(0, document.body.scrollHeight);	
	  });
      
      socket.on('responseFromHttpServer', function(data){
		  data = JSON.parse(data);
		  //console.log("Soundlist current level: "+ data.absLoudLevel +  " event: " + data.event);
		  if(data.event != "Blank") {
			//Calculate date
			var date = new Date();
			date.setSeconds(date.getSeconds() - data.duration - lengthOfGapInSec);
			var hours = date.getHours(), 
				minutes = date.getMinutes(), 
				seconds = date.getSeconds();
			if (minutes < 10) {minutes = "0" + minutes;}
			if (seconds < 10) {seconds = "0" + seconds;}
			
			$('#eventTable tr:last').after('<tr><td>' + hours + ':' + minutes + ':' + seconds +  '</td> <td>' + data.event + '</td> <td>' + data.clientid + '</td> <td>'  + data.duration + 's</td> </tr>');
			
			window.scrollTo(0, document.body.scrollHeight);
          }
          
          if(data.clientid == FIRST_ROOM)
			$('#historyTable tr#first-room').replaceWith('<tr id="first-room"><td>' + data.clientid + '</td> <td>' +data.numOfEventsInDay[0] + '</td> <td>' + data.numOfEventsInDay[1] + '</td> <td>'  + data.numOfEventsInDay[2]  + '</td> </tr>');
		  else if(data.clientid == SECOND_ROOM)
			$('#historyTable tr#second-room').replaceWith('<tr id="second-room"><td>' + data.clientid  + '</td> <td>' +data.numOfEventsInDay[0] + '</td> <td>' + data.numOfEventsInDay[1] + '</td> <td>'  + data.numOfEventsInDay[2]  + '</td> </tr>');
      });
      
      /** Error Handling. See: https://socket.io/docs/client-api/ **/
	  socket.on('connect_error', function() {console.log("Soundlist: connect_error or connect_timeout");});
	  socket.on('disconnect', function() {console.log("Soundlist: disconnected");});
    </script>
	
  </body>
</html>
