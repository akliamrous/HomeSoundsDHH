<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="jm3">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>d3 audio waveforms</title>
    
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Roboto:400,100|Raleway:400,200|Amatic+SC">
    <style>
		* {
		  margin:      0;
		  font-family: 'Amatic SC', cursive;
		}
		html {
		  margin: 1.0em;
		}
		h1 {
		  font-size:    48px;
		  font-weight:  bold;
		}
		h1 a,
		h1 a:visited {
		  text-decoration:  none;
		  font-weight:      normal;
		  font-size:        90%;
		  color:            #000;
		  border-bottom:    1px dashed #bbb;
		}
		h1 a:hover {
		  color: red;
		}
		.waveform > svg,
		.waveform > div {
		  border:       2px solid #ddd;
		  height:       140px;
		  margin-left:  40px;
		  padding:      2px;
		  position:     relative;
		  width:        880px;
		}
		.waveform h2 {
		  margin-left:  40px;
		  font-size:    36px;
		}
		.waveform > div div.bar {
		  background-color:  red;
		  position:          absolute;
		}
		.waveform .svg1 g rect {
		  fill:     red;
		  opacity:  0.5;
		}
		.waveform .svg2 g rect {
		  fill:     green;
		  opacity:  0.5;
		}
		.soundcloud_embed {
		  display:     none;
		  opacity:     0.5;
		  margin-left: 40px;
		  width:       968px;
		  /* weird padding offset; SC embed is slightly too short? */
		}
		.axis {
		  position: absolute;
		  top:      4px;
		  left:    -40px;
		}
		.axis g path.domain {
		  display: none;
		}
		.axis g text {
		  font-family: 'Roboto', sans-serif;
		  opacity:      0.5;
		  font-size:    10px;
		}
    </style> 
  </head>
  <body>
    <div class="page">
      <div class="waveform">
        <div class="svg svg1">	
        </div>
        <div class="svg svg2">
		</div>
      </div>
    </div>

    <script>
		var FIRST_ROOM = "dj-office", SECOND_ROOM = "jon-office", THIRD_ROOM = "dj-home";
		
		var wave_json1 = wave_json2 = Array.from({length: 1024}, () => 0);
		
		var max_points = 1024;
		var width = 880, height = 140; 		//$(".svg").css(width),
		
		/**** Data from Socket ****/
		  var socket = io.connect();
		  socket.on('responseFromHttpServer', function(data){
			  
			  data = JSON.parse(data);
			  
			  if(data.clientid == FIRST_ROOM)
			  {
				y1 = parseFloat(data.dataFromHttpServer);
				wave_json1.shift();
				wave_json1.push(y1);
				console.log("Waveform 1:" + y1);
				d3.selectAll(".svg1 svg").remove();
				svg_render(wave_json1, ".waveform > .svg1" );
			  }	
			  
			  if(data.clientid == SECOND_ROOM)
			  {
				y2 = parseFloat(data.dataFromHttpServer);
				wave_json2.shift();
				wave_json2.push(y2);
				console.log("Waveform 2:" + y2);
				d3.selectAll(".svg2 svg").remove();
				svg_render(wave_json2, ".waveform > .svg2" );
			  }	
		  });

		/**** Waveform *****/
		function svg_render(data, svg) {
		  var node = d3.select(svg).append("svg")
			.attr("class","chart")
			.attr("width", width)
			.attr("height", height);

		  var y = d3.scale.linear().range([height, -height]);
		  var max_val = d3.max(data, function(d) { return d; });
		  y.domain([-max_val, max_val]);
		  var x = d3.scale.linear().domain([0, data.length]);
		  var bar_width = width / data.length;

		  var chart = node.attr("width", width).attr("height", height);

		  var bar = chart.selectAll("g")
			.data(data)
			.enter().append("g") // svg "group"
			.attr("transform", function(d, i) {
			  return "translate(" + i * bar_width + ",0)";
			});

		  bar.append("rect")
			.attr("y", function(d) {
			  var yv = height - Math.abs(y(d)/2) - height/2 + 2;
			  return yv;
			})
			.attr("height", function(d) {
			  return Math.abs(y(d)); })
			.attr("width", bar_width );

		  var axis = d3.svg.axis()
			.scale(y)
			.ticks(12)
			.orient("left");

		  d3.select(svg).append("svg")
			.attr("class", "axis")
			.attr("width", 60)
			.attr("height", height)
			.append("g")
			.attr("transform", "translate(40," + (height/2) + ")" )
			.call(axis);
		}

		function d( s ) {
		  console.log( "log: " + s );
		}
    </script>
  </body>
</html>
