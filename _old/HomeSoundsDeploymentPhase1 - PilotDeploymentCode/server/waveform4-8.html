<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="jm3">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<!--<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Roboto:400,100|Raleway:400,200|Amatic+SC"> -->
	<style>
		* {
			font-family: Helvetica, Arial;
			background-color: #fafafa;
			margin: 0;
			padding: 0;
		}

		.waveform>svg,
		.waveform>div {
			border: 2px solid #ccc;
			height: 180px;
			top: 35px;
			position: relative;
			width: 30.5%;
			display: inline-block;
			overflow:  hidden;
		}

		.svg1, .svg2 {
			margin-left:17px;
			margin-right:17px;
		}

		.svg3 {
			margin-left: 15px;
			margin-right: 0;
		}

		h2 {
			/*margin-left: 3px;
			font-size: 22px;
			color: #999;
			font-family: Helvetica, Arial;
			font-weight: bold; */
			position: absolute;
			top: 91.2%; 
			left: 1.5%;
			font: 12px helvetica;
      		color: #555;
		}
		
		h1 {
			margin-left: 3px;
			font-size: 22px;
			color: #999;
			font-family: Helvetica, Arial;
			font-weight: bold;
			position: absolute;
			top: 44%; 
			left: 32%;
		}

		.waveform>div div.bar {
			position: absolute;
		}

		.marquee {
			color: #666;
			font-size: 12px;
			position: absolute;
			top: calc(100% - 14px);
			width: 100%;
			height: 100%;
			animation: marquee 28.4s linear;
			white-space: nowrap;
		}

		@keyframes marquee {
			100% {
				transform: translateX(-100%);
			}
		}
	</style>
</head>

<body>
		<div class="waveform">
			<div class="svg1">
				<h2>DJ's Home</h2>
				<h1>Not connected</h1>
			</div>
			<div class="svg2">
				<h2>DJ's Office</h2>
				<h1>Not connected</h1>
			</div>
			<div class="svg3">
				<h2>Jon's Office</h2>
				<h1>Not connected</h1>
			</div>
		</div>

	<script>
		/* Performance is increased by reducing the number of data points or by reducing data updatae time.
		 * If you reduce the number of data points, the granurality is lower and hence you can use the functions below (divide by 2 etc.) to make it all look better.
		 * Another trick (not recommended) is to increase the data updatae time while also increasing the points (coz generating 512 point time is not double of 256 point time)
		 * This way the eye wouldn't see big lines moving too fast....
		 */
		var FIRST_ROOM = "dj-home", SECOND_ROOM = "dj-office", THIRD_ROOM = "jon-office";
		
		/** Set during handshake */
		var colors = ["#ff7f0e", "#1f77b4", "#2ca02c", "#d62728", "#9467bd"];
		$('.svg1').css('fill', colors[0]); $('.svg2').css('fill', colors[1]); $('.svg3').css('fill', colors[2]);

		var numOfPoints = 512;				// Number of points  = 256. Orig = 1024 (which increases granurality but decreases performance and also decreases speed of updatae of waveform)			
		var min_max_val = 6;	//7.5		// IMP: CHANGE BASED ON MIC VOLUME AND HOW IT LOOKS. Remeber that graph doesn't show all value.
		var max_val = min_max_val;
		var data1 = [0.0,0.0], data2 = [0.0,0.0], data3 = [0.0,0.0];

		//D3 specific elements
		var width = $('.waveform > div').width(), height = $('.waveform > div').height();
		var bar_width = width / (numOfPoints);							// Dividing by 2 reduces the number of path points. This allows to reduce the array length above while keeping same granularity (width of bars) by introducing space between the bars	

		//Sound event specific elements
		var secToPerWidth = sec => sec * 100 / parseFloat($('.marquee').css('animationDuration'));		//This does not account for width of marquee element. TODO: Also, set the marquee element width based on server handshake (data sample size)
		var lengthOfGapInSec = 1;
		var numOfSamplesPerSec = 20;
		var firstTime = 1;

		/**** data from Socket ****/
		var socket = io.connect();					//URL is windows.location (url address of the webpage), timeout: 5 days

		// Send handshake
		socket.on('connect', function () {
			console.log("Waveform connected to server!");
			socket.emit('handshake', "http-waveform");
		});
		

		socket.on('handshake-server-wave', function (data) {
			data = JSON.parse(data);
			if (firstTime) {
				lengthOfGapInSec = parseFloat(data.lengthOfGapInSec);
				numOfSamplesPerSec = parseFloat(data.numOfSamplesPerSec);
				numOfPoints = parseInt(data.numOfWaveformPoints);
				bar_width = width / (numOfPoints);

				var wave1 = [...Array(numOfPoints)].map(e => Array(2).fill(0.0)), 
					wave2 = [...Array(numOfPoints)].map(e => Array(2).fill(0.0)),
					wave3 = [...Array(numOfPoints)].map(e => Array(2).fill(0.0));
				
				//waveformArray = clientid, data.dataFromDataClient, data.pitchFromDataClient
				for (var i = 0; i < (data.waveformArray).length; i++)
				{
					if(data.waveformArray[i][0] == FIRST_ROOM) {
						wave1.shift();
						wave1.push([parseFloat(data.waveformArray[i][1]), parseFloat(data.waveformArray[i][2])]);
					}	
					else if(data.waveformArray[i][0] == SECOND_ROOM) {
						wave2.shift();
						wave2.push([parseFloat(data.waveformArray[i][1]), parseFloat(data.waveformArray[i][2])]);
					}
					else if(data.waveformArray[i][0] == THIRD_ROOM) {
						wave3.shift();
						wave3.push([parseFloat(data.waveformArray[i][1]), parseFloat(data.waveformArray[i][2])]);
					}
				}
				svg_creater(wave1, '.svg1', min_max_val);
				svg_creater(wave2, '.svg2', min_max_val);
				svg_creater(wave3, '.svg3', min_max_val);

				firstTime = 0;
				
				setInterval(() => {
					if(socket.connected)
						window.requestAnimationFrame ( () => {
							svg_updater(data1, ".svg1", min_max_val);
						});
				}, 50);

				setInterval(() => { 
					if(socket.connected)
						window.requestAnimationFrame ( () => {
							svg_updater(data2, ".svg2", min_max_val);
						});
				}, 50);

				setInterval(() => { 
					if(socket.connected)
						window.requestAnimationFrame ( () => {
							svg_updater(data3, ".svg3", min_max_val);
						});
				}, 50);
			}
		});

		socket.on('goodbye-server', function (clientid) {
			if (clientid == FIRST_ROOM)
			{
				data1 = [0.0, 0.0];
				$('.svg1 h1').css('visibility', 'visible');	
			}
			else if (clientid == SECOND_ROOM)
			{
				data2 = [0.0, 0.0];
				$('.svg2 h1').css('visibility', 'visible');
			}
			else if (clientid == THIRD_ROOM)
			{
                data3 = [0.0, 0.0];
				$('.svg3 h1').css('visibility', 'visible');
			}
		});


		socket.on('responseFromHttpServer-waveform', function (data) {
			data = JSON.parse(data);

			if (data.clientid == FIRST_ROOM) {
				
                data1 = [parseFloat(data.dataFromHttpServer), parseFloat(data.pitchFromHttpServer)];
                window.requestIdleCallback(() => {
                        $('.svg1 h1').css('visibility', 'hidden');
                });
                //if (data.event != "Blank")
				//	event_adder(".svg1", data.event, parseFloat(data.duration), lengthOfGapInSec);
			}

			if (data.clientid == SECOND_ROOM) {
                data2 = [parseFloat(data.dataFromHttpServer), parseFloat(data.pitchFromHttpServer)];
				window.requestIdleCallback(() => {
                        $('.svg2 h1').css('visibility', 'hidden');
                });
				//if (data.event != "Blank")
				//    event_adder(".svg2", data.event, parseFloat(data.duration), lengthOfGapInSec);
			}

			if (data.clientid == THIRD_ROOM) {
                data3 = [parseFloat(data.dataFromHttpServer), parseFloat(data.pitchFromHttpServer)];
				window.requestIdleCallback(() => {
                        $('.svg3 h1').css('visibility', 'hidden');
                });
				//if (data.event != "Blank")
				//    event_adder(".svg2", data.event, parseFloat(data.duration), lengthOfGapInSec);
			}

		});
		//event_adder(".svg2", "Loud", 0.75, 1);
		/**** Events *****/
		function event_adder(clas, event, duration, gapLen) {
			var id = new Date().getTime();

			$(clas).append("<span class='marquee " + id + "'>" + event + ", " + duration + "s</span>");

			var time_adjust = parseFloat($('.marquee').css('animationDuration')) / (numOfPoints / numOfSamplesPerSec);
			var animationDuration = parseFloat($('.marquee').css('animationDuration')) - (duration + gapLen) * time_adjust;
			$('.' + id).css({ 'animationDuration': animationDuration + 's' });

			var tra = -secToPerWidth(duration + gapLen);
			$('.' + id).css({ 'transform': 'translateX(' + tra + '%)' });

			setTimeout(function () {
				$('.' + id).remove();
			}, animationDuration * 1000);
		}

		/**** Waveform *****/

		var y = d3.scaleLinear().range([height, -height]);
		y.domain([-max_val, max_val]);

		function svg_creater(data, svg, max_val) {

			var chart = d3.select(svg).append("svg")
				.attr("class", "chart")
				.attr("width", width)
				.attr("height", height);

			var grp = chart.append("g")
				.attr("transform", "translate(0,0)");

			grp.selectAll("rect")
				.data(data)
				.enter().append("rect")
				.attr("transform", function (d, i) {
					return "translate(" + i * bar_width + ",0)";
				})
				.attr("y", function (d) {
					return height - Math.abs(y(d[0]) / 2) - height / 2 + 2;
				})
				.attr("height", function (d) {
					return Math.abs(y(d[0]));
				})
				.attr("width", bar_width)
				.attr("opacity", function (d) {
					return 0.4 + 0.6*d[1] /5000;
				});
		}

		function svg_updater(data, svg, max_val) {

			var chart = d3.select(svg).select("svg");
			var grp = chart.select("g");
			var grpTransform = grp.attr("transform");
			var xCoor = (grpTransform.substring(grpTransform.indexOf("(") + 1, grpTransform.indexOf(")")).split(",")[0]) - bar_width;

			grp.insert("rect")
				.attr("transform", function (d, i) {
					return "translate(" + (numOfPoints * bar_width - xCoor) + ",0)";
				})
				.attr("y", height - Math.abs(y(data[0]) / 2) - height / 2 + 2)
				.attr("height", Math.abs(y(data[0])))
				.attr("width", bar_width)
				.attr("opacity", 0.4 + 0.6*data[1]/ 5000);

			grp.attr("transform", "translate(" + xCoor + ",0)");

			grp.select("rect")
				.remove();

			/*
			grp.insert("rect")
				.attr("transform", function (d, i) {
					return "translate(" + (numOfPoints * bar_width - xCoor) + ",0)";
				})
				.attr("y", height - Math.abs(y(data[0]) / 2) - height / 2 + 2)
				.attr("height", Math.abs(y(data[0])))
				.attr("width", bar_width)
				.attr("opacity", 0.4 + 0.6*data[1]/ 5000);

			grp.attr("transform", "translate(" + (xCoor + bar_width) + ",0)")
				.transition()
				.duration(50)
				.ease(d3.easeLinear)
				.attr("transform", "translate(" + xCoor + ",0)");

			grp.select("rect")
				.transition()
				.remove();
			*/

		}
		/** Error Handling. See: https://socket.io/docs/client-api/ **/
		socket.on('connect_error', function () { console.log("Waveform: connect_error or connect_timeout"); });
		socket.on('disconnect', function () { 
			console.log("Waveform: disconnected"); 
			$('.svg1 h1').css('visibility', 'visible');
			$('.svg2 h1').css('visibility', 'visible');
			$('.svg3 h1').css('visibility', 'visible');
		});
		socket.on('reload', function () {
			location.reload();
		});
		
	</script>
</body>

</html>
